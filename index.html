<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Laporan Tonase</title>
    <!-- 1. Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Memuat Pustaka PDF: jsPDF dan html2canvas -->
    <!-- html2canvas untuk "mengambil gambar" elemen HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF untuk membuat file PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* Menggunakan font Inter yang modern */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style tambahan untuk memastikan konten PDF terlihat bagus */
        #laporan-container {
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="max-w-7xl mx-auto p-4 md:p-8">

        <!-- Modal Kustom (Pengganti Alert/Confirm) -->
        <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
                <h3 id="modal-title" class="text-lg font-bold mb-4">Judul Modal</h3>
                <p id="modal-message" class="text-gray-700 mb-6">Isi pesan modal.</p>
                <div class="flex justify-end space-x-4">
                    <button id="modal-cancel" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">
                        Batal
                    </button>
                    <button id="modal-ok" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        OK
                    </button>
                </div>
            </div>
        </div>

        <h1 class="text-3xl font-bold text-center text-gray-700 mb-8">
            Aplikasi Laporan Harian Tonase
        </h1>

        <!-- Kontainer utama dengan layout grid -->
        <div class="md:grid md:grid-cols-3 md:gap-8">

            <!-- Kolom 1: Formulir Input -->
            <div class="md:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700 border-b pb-3">
                    Input Data Pengiriman
                </h2>
                <form id="data-form" class="space-y-4">
                    <div>
                        <label for="tanggal" class="block text-sm font-medium text-gray-600 mb-1">
                            Tanggal Laporan
                        </label>
                        <input type="date" id="tanggal" name="tanggal" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    
                    <div>
                        <label for="no-unit" class="block text-sm font-medium text-gray-600 mb-1">
                            No. Unit
                        </label>
                        <input type="text" id="no-unit" name="no-unit" placeholder="Contoh: 4" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                    </div>

                    <div>
                        <label for="no-polisi" class="block text-sm font-medium text-gray-600 mb-1">
                            No. Polisi
                        </label>
                        <input type="text" id="no-polisi" name="no-polisi" placeholder="Contoh: B 1234 ABC" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- INPUT BARU DITAMBAHKAN DI SINI -->
                    <div>
                        <label for="jenis-material" class="block text-sm font-medium text-gray-600 mb-1">
                            Jenis Material
                        </label>
                        <input type="text" id="jenis-material" name="jenis-material" placeholder="Contoh: Batu Bara" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label for="pengiriman-kemana" class="block text-sm font-medium text-gray-600 mb-1">
                            Pengiriman
                        </label>
                        <input type="text" id="pengiriman-kemana" name="pengiriman-kemana" placeholder="Contoh: PLTU" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <!-- AKHIR INPUT BARU -->

                    <div>
                        <label for="hasil-tonase" class="block text-sm font-medium text-gray-600 mb-1">
                            Hasil Tonase (Ton)
                        </label>
                        <input type="number" id="hasil-tonase" name="hasil-tonase" placeholder="Contoh: 39.210" step="0.001" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                    </div>

                    <div>
                        <label for="harga-tonase" class="block text-sm font-medium text-gray-600 mb-1">
                            Harga per Ton (Rp)
                        </label>
                        <input type="number" id="harga-tonase" name="harga-tonase" placeholder="Contoh: 115000" step="1" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                    </div>

                    <div>
                        <label for="uang-jalan" class="block text-sm font-medium text-gray-600 mb-1">
                            Uang Jalan (Rp)
                        </label>
                        <input type="number" id="uang-jalan" name="uang-jalan" placeholder="Contoh: 2500000" step="1" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                    </div>

                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md">
                        + Tambah Data ke Laporan
                    </button>
                </form>
            </div>

            <!-- Kolom 2: Pratinjau Laporan -->
            <div class="md:col-span-2 mt-8 md:mt-0">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-3 sm:mb-0">
                        Preview Laporan
                    </h2>
                    <button id="export-pdf-btn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition duration-300 shadow-md">
                        Export ke PDF
                    </button>
                </div>
                
                <!-- Ini adalah area yang akan diekspor ke PDF -->
                <div id="laporan-container" class="bg-white p-6 md:p-10 rounded-xl shadow-lg">
                    <!-- HEADER BARU DITAMBAHKAN DI SINI -->
                    <div class="text-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">
                            PT. Mahaputra Baruna Logistik
                        </h2>
                        <p class="text-md text-gray-600">
                            Bayah Mineral Flow Transport Project
                        </p>
                    </div>
                    <!-- AKHIR HEADER BARU -->

                    <h3 id="laporan-judul" class="text-xl md:text-2xl font-bold text-center text-gray-800 mb-6 pb-4 border-b">
                        Laporan Hasil Tonase
                    </h3>
                    
                    <!-- Konten dinamis akan diisi oleh JavaScript -->
                    <div id="laporan-isi" class="space-y-5">
                        <p class="text-gray-500 text-center">Belum ada data yang ditambahkan.</p>
                    </div>
                    
                    <!-- Total keseluruhan -->
                    <div id="laporan-total" class="mt-8 pt-6 border-t-2 border-gray-300 border-dashed">
                        <!-- Total akan diisi oleh JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 3. Logika JavaScript
        
        // --- LOGIKA MODAL KUSTOM ---
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalOk = document.getElementById('modal-ok');
        const modalCancel = document.getElementById('modal-cancel');
        let modalResolver = null; // Untuk menyimpan fungsi resolve dari Promise

        // Listener untuk tombol OK
        modalOk.addEventListener('click', () => {
            if (modalResolver) modalResolver(true); // Resolve promise dengan 'true'
            modal.classList.add('hidden');
            modalResolver = null;
        });

        // Listener untuk tombol Batal
        modalCancel.addEventListener('click', () => {
            if (modalResolver) modalResolver(false); // Resolve promise dengan 'false'
            modal.classList.add('hidden');
            modalResolver = null;
        });

        // Fungsi untuk menampilkan Alert (hanya tombol OK)
        function showCustomAlert(message) {
            modalTitle.textContent = 'Peringatan';
            modalMessage.textContent = message;
            modalOk.textContent = 'OK';
            modalCancel.classList.add('hidden'); // Sembunyikan tombol batal
            modal.classList.remove('hidden');
            
            return new Promise((resolve) => {
                modalResolver = resolve; // Promise akan resolve saat OK diklik
            });
        }

        // Fungsi untuk menampilkan Confirm (OK dan Batal)
        function showCustomConfirm(message) {
            modalTitle.textContent = 'Konfirmasi';
            modalMessage.textContent = message;
            modalOk.textContent = 'Ya';
            modalCancel.textContent = 'Batal';
            modalCancel.classList.remove('hidden'); // Tampilkan tombol batal
            modal.classList.remove('hidden');

            return new Promise((resolve) => {
                modalResolver = resolve; // Promise akan resolve (true/false)
            });
        }
        // --- AKHIR LOGIKA MODAL KUSTOM ---


        // Mengimpor jsPDF dari window
        const { jsPDF } = window.jspdf;

        // Variabel global untuk menyimpan data
        let dataPengiriman = [];
        let tanggalLaporan = "";

        // Referensi Elemen DOM
        const form = document.getElementById('data-form');
        const tanggalInput = document.getElementById('tanggal');
        const noUnitInput = document.getElementById('no-unit');
        const noPolisiInput = document.getElementById('no-polisi');
        // -- Input Baru --
        const jenisMaterialInput = document.getElementById('jenis-material');
        const pengirimanKemanaInput = document.getElementById('pengiriman-kemana');
        // -- Akhir Input Baru --
        const hasilTonaseInput = document.getElementById('hasil-tonase');
        const hargaTonaseInput = document.getElementById('harga-tonase');
        const uangJalanInput = document.getElementById('uang-jalan');
        
        const laporanJudul = document.getElementById('laporan-judul');
        const laporanIsi = document.getElementById('laporan-isi');
        const laporanTotal = document.getElementById('laporan-total');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const laporanContainer = document.getElementById('laporan-container');

        // Helper untuk format Rupiah
        function formatRupiah(angka) {
            // ... (fungsi formatRupiah tetap sama) ...
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(angka);
        }

        // Helper untuk format Tanggal
        function formatTanggal(tanggalString) {
            // ... (fungsi formatTanggal tetap sama) ...
            if (!tanggalString) return "";
            const date = new Date(tanggalString);
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            const adjustedDate = new Date(date.getTime() + userTimezoneOffset);
            
            return adjustedDate.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
        }
        
        // Helper untuk format Angka (Tonase)
        function formatAngka(angka) {
            // ... (fungsi formatAngka tetap sama) ...
             return new Intl.NumberFormat('id-ID', {
                minimumFractionDigits: 3,
                maximumFractionDigits: 3
            }).format(angka);
        }

        // Fungsi untuk me-render ulang laporan di HTML
        function renderLaporan() {
            // 1. Kosongkan isi laporan sebelumnya
            laporanIsi.innerHTML = '';
            laporanTotal.innerHTML = '';

            if (dataPengiriman.length === 0) {
                laporanJudul.textContent = 'Laporan Hasil Tonase';
                laporanIsi.innerHTML = '<p class="text-gray-500 text-center">Belum ada data yang ditambahkan.</p>';
                return;
            }

            // 2. Set Judul Laporan
            laporanJudul.textContent = `Laporan Hasil Tonase Tanggal: ${formatTanggal(tanggalLaporan)}`;

            let grandTotalBersih = 0;
            let listUnit = [];

            // 3. Loop data dan buat elemen HTML
            dataPengiriman.forEach(entry => {
                // -- Perbarui template HTML untuk menyertakan data baru --
                const itemHTML = `
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h4 class="font-bold text-lg text-gray-800">
                            Unit ${entry.noUnit} (${entry.noPolisi})
                        </h4>
                        <ul class="list-disc list-inside ml-2 space-y-1 text-gray-700 mt-2">
                            <li>Jenis Material: <strong>${entry.jenisMaterial}</strong></li>
                            <li>Pengiriman Kemana: <strong>${entry.pengirimanKemana}</strong></li>
                            <li>Hasil Timbangan: <strong>${formatAngka(entry.hasilTonase)} Ton</strong></li>
                            <li>Harga per Ton: <strong>${formatRupiah(entry.hargaTonase)}</strong></li>
                            <li>Total Muatan: <strong>${formatRupiah(entry.totalMuatan)}</strong></li>
                            <li>Uang Jalan: <strong>${formatRupiah(entry.uangJalan)}</strong></li>
                            <li class="font-semibold text-gray-900">Total Bersih: <strong class="text-blue-600">${formatRupiah(entry.totalBersih)}</strong></li>
                        </ul>
                    </div>
                `;
                laporanIsi.innerHTML += itemHTML;

                // 4. Akumulasi total
                grandTotalBersih += entry.totalBersih;
                listUnit.push(entry.noUnit);
            });

            // 5. Render Total Keseluruhan
            // ... (fungsi total tetap sama) ...
            const unitString = listUnit.join(', ');
            const totalHTML = `
                <h4 class="font-bold text-lg md:text-xl text-gray-800">
                    Total Keseluruhan (Unit ${unitString})
                </h4>
                <p class="text-2xl md:text-3xl font-bold text-blue-700 mt-2">
                    ➡️ <i class="italic">${formatRupiah(grandTotalBersih)}</i>
                </p>
            `;
            laporanTotal.innerHTML = totalHTML;
        }

        // Event Listener untuk Form Submit (dijadikan async untuk modal)
        form.addEventListener('submit', async function(e) {
            e.preventDefault(); // Mencegah form reload halaman

            // 1. Ambil data dari form
            const tanggal = tanggalInput.value;
            const noUnit = noUnitInput.value;
            const noPolisi = noPolisiInput.value || '-'; // Default jika kosong
            // -- Ambil data baru --
            const jenisMaterial = jenisMaterialInput.value || '-';
            const pengirimanKemana = pengirimanKemanaInput.value || '-';
            // -- Akhir data baru --
            const hasilTonase = parseFloat(hasilTonaseInput.value);
            const hargaTonase = parseFloat(hargaTonaseInput.value);
            const uangJalan = parseFloat(uangJalanInput.value);

            // 2. Validasi sederhana
            if (!tanggal || !noUnit || isNaN(hasilTonase) || isNaN(hargaTonase) || isNaN(uangJalan)) {
                // Ganti alert() dengan modal kustom
                await showCustomAlert("Harap isi semua field wajib (Tanggal, No. Unit, Tonase, Harga, Uang Jalan) dengan benar.");
                return;
            }

            // 3. Set tanggal laporan (hanya jika ini data pertama atau tanggal berubah)
            if (dataPengiriman.length === 0) {
                tanggalLaporan = tanggal;
            } else if (tanggal !== tanggalLaporan) {
                // Ganti confirm() dengan modal kustom
                const gantiTanggal = await showCustomConfirm("Tanggal berbeda. Apakah Anda ingin memulai laporan baru untuk tanggal ini? Data lama akan dihapus.");
                if (gantiTanggal) { // Jika user klik 'Ya'
                    dataPengiriman = [];
                    tanggalLaporan = tanggal;
                } else { // Jika user klik 'Batal'
                    tanggalInput.value = tanggalLaporan; // Kembalikan ke tanggal lama
                    return;
                }
            }

            // 4. Lakukan Kalkulasi
            const totalMuatan = hasilTonase * hargaTonase;
            const totalBersih = totalMuatan - uangJalan;

            // 5. Buat objek data (termasuk data baru)
            const dataBaru = {
                noUnit,
                noPolisi,
                jenisMaterial, // Tambahkan
                pengirimanKemana, // Tambahkan
                hasilTonase,
                hargaTonase,
                uangJalan,
                totalMuatan,
                totalBersih
            };

            // 6. Masukkan ke array data
            dataPengiriman.push(dataBaru);
            
            // Urutkan data berdasarkan No. Unit
            dataPengiriman.sort((a, b) => a.noUnit.localeCompare(b.noUnit, undefined, {numeric: true}));

            // 7. Render ulang laporan
            renderLaporan();

            // 8. Kosongkan form (kecuali tanggal dan harga, untuk memudahkan)
            noUnitInput.value = '';
            noPolisiInput.value = '';
            // -- Kosongkan input baru --
            jenisMaterialInput.value = '';
            pengirimanKemanaInput.value = '';
            // -- Akhir --
            hasilTonaseInput.value = '';
            uangJalanInput.value = '';
            noUnitInput.focus(); // Fokus ke input No. Unit
        });

        // Event Listener untuk tombol Export PDF (dijadikan async untuk modal)
        exportPdfBtn.addEventListener('click', async function() {
            if (dataPengiriman.length === 0) {
                // Ganti alert() dengan modal kustom
                await showCustomAlert("Tidak ada data untuk diekspor. Harap tambahkan data terlebih dahulu.");
                return;
            }
            
            // Tampilkan pesan loading sederhana
            exportPdfBtn.textContent = "Memproses PDF...";
            exportPdfBtn.disabled = true;

            // Gunakan html2canvas untuk "menggambar" elemen laporan
            html2canvas(laporanContainer, {
                scale: 2, // Meningkatkan resolusi gambar
                useCORS: true 
            }).then(canvas => {
                // ... (Logika jsPDF tetap sama) ...
                const imgData = canvas.toDataURL('image/png');
                const doc = new jsPDF('p', 'pt', 'a4');
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = doc.internal.pageSize.getHeight();
                const imgProps = doc.getImageProperties(imgData);
                const imgWidth = imgProps.width;
                const imgHeight = imgProps.height;
                const ratio = pdfWidth / imgWidth;
                const scaledHeight = imgHeight * ratio;
                let heightLeft = scaledHeight;
                let position = 0; 
                doc.addImage(imgData, 'PNG', 0, position, pdfWidth, scaledHeight);
                heightLeft -= pdfHeight;
                while (heightLeft > 0) {
                    position = heightLeft - scaledHeight; 
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, pdfWidth, scaledHeight);
                    heightLeft -= pdfHeight;
                }
                const namaFile = `Laporan_Tonase_${tanggalLaporan}.pdf`;
                doc.save(namaFile);
                
                exportPdfBtn.textContent = "Export ke PDF";
                exportPdfBtn.disabled = false;
                
            }).catch(async (err) => { // Tambahkan async di sini
                console.error("Error saat membuat PDF:", err);
                // Ganti alert() dengan modal kustom
                await showCustomAlert("Terjadi kesalahan saat membuat PDF. Lihat konsol untuk detail.");
                exportPdfBtn.textContent = "Export ke PDF";
                exportPdfBtn.disabled = false;
            });
        });

        // Render laporan saat pertama kali dimuat (tampilan kosong)
        renderLaporan();
    </script>
</body>
</html>

